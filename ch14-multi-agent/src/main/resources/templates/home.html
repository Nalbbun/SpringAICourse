<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Travel Planner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="d-flex flex-column vh-100 bg-light" style="overflow: hidden;">    
    <!-- Header -->
    <nav class="navbar bg-white shadow-sm">
        <div class="container-fluid">
            <a href="/" class="navbar-brand">
                <img src="/image/spring_ai_logo_with_text.svg" width="200" alt="Spring AI">
            </a>
        </div>
    </nav>

    <!-- Page Header -->
    <header class="bg-primary bg-gradient text-white py-3 shadow">
        <div class="container">
            <a href="/" class="text-white text-decoration-none d-inline-block mb-2 opacity-75">
                <i class="fas fa-arrow-left me-2"></i>í™ˆìœ¼ë¡œ
            </a>
            <h1 class="h4 fw-bold mb-1">
                <i class="fas fa-robot me-2"></i>Multi-Agent Travel Planner
            </h1>
            <p class="mb-0 small opacity-75">
                <i class="fas fa-info-circle me-1"></i>
                ë³‘ë ¬ ì‹¤í–‰ â€¢ ìƒíƒœ ê´€ë¦¬ â€¢ ì¡°ê±´ë¶€ ì¬ê³„íš â€¢ SSE ìŠ¤íŠ¸ë¦¬ë°
            </p>
        </div>
    </header>


    <!-- Main Content -->
    <div class="container-fluid flex-fill overflow-hidden p-3 d-flex flex-column">
        <div class="card shadow border-0 d-flex flex-column h-100">
            <!-- Chat Messages Area -->
            <div class="card-body p-4 bg-light overflow-auto" id="chatMessages" style="flex: 1; min-height: 0;">
                <!-- Welcome Message -->
                <div class="d-flex align-items-start mb-3 animate__animated animate__fadeIn">
                    <div class="text-white rounded-circle d-flex align-items-center justify-content-center me-3 shadow" style="width: 45px; height: 45px; flex-shrink: 0; font-weight: bold; font-size: 1rem; background-color: #6db33f;">
                        AI
                    </div>
                    <div class="bg-white rounded-3 p-4 shadow-sm" style="max-width: 80%;">
                        <h6 class="mb-3"><i class="fas fa-hand-sparkles me-2 text-primary"></i>ì•ˆë…•í•˜ì„¸ìš”!</h6>
                        <p class="mb-2">ì œì£¼ë„ ì—¬í–‰ ê³„íšì„ ë„ì™€ë“œë¦¬ëŠ” Multi-Agent ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ğŸŒ´</p>
                        <p class="mb-0 small text-muted">
                            <strong>ì˜ˆ:</strong> "ì œì£¼ë„ 2ë°•3ì¼ 50ë§Œì› ì˜ˆì‚°ìœ¼ë¡œ ì—¬í–‰ ê³„íš ì§œì¤˜"
                        </p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="card-footer bg-white border-top p-3">
                <div class="mb-2">
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-sm btn-outline-success" onclick="setQuickMessage('ì œì£¼ë„ 2ë°•3ì¼ 50ë§Œì› ì˜ˆì‚°ìœ¼ë¡œ ì—¬í–‰ ê³„íš ì§œì¤˜')">
                            <i class="fas fa-umbrella-beach me-1"></i>ì œì£¼ë„ 2ë°•3ì¼ 50ë§Œì›
                        </button>                        
                        <button class="btn btn-sm btn-outline-primary" onclick="setQuickMessage('ì œì£¼ë„ 2ë°•3ì¼ 20ë§Œì› ì˜ˆì‚°ìœ¼ë¡œ ì—¬í–‰ ê³„íš ì§œì¤˜')">
                            <i class="fas fa-umbrella-beach me-1"></i>ì œì£¼ë„ 2ë°•3ì¼ 20ë§Œì›
                        </button>
                    </div>
                </div>
                <div class="input-group">
                    <input type="text" id="messageInput" class="form-control form-control-lg" 
                           placeholder="ì œì£¼ë„ 2ë°•3ì¼ 50ë§Œì› ì˜ˆì‚°ìœ¼ë¡œ ì—¬í–‰ ê³„íš ì§œì¤˜." 
                           onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button class="btn btn-primary bg-gradient text-white px-4" id="sendButton" onclick="sendMessage()">
                        <i class="fas fa-paper-plane me-2"></i>ì „ì†¡
                    </button>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>
                        <strong>Tip:</strong> "ì—¬í–‰ì§€ + ê¸°ê°„ + ì˜ˆì‚°"ì„ í•¨ê»˜ ì…ë ¥í•˜ë©´ ë” ì •í™•í•œ ê³„íšì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentEventSource = null;

        function setQuickMessage(msg) {
            document.getElementById('messageInput').value = msg;
            document.getElementById('messageInput').focus();
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const userMessage = messageInput.value.trim();
            
            if (!userMessage) {
                alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addUserMessage(userMessage);
            messageInput.value = '';

            // AI ì‘ë‹µ ë©”ì‹œì§€ ì¤€ë¹„ (íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°)
            const aiMessageId = 'ai-' + Date.now();
            const aiMessageDiv = addTypingIndicator(aiMessageId);

            // ì…ë ¥ ë¹„í™œì„±í™”
            messageInput.disabled = true;
            document.getElementById('sendButton').disabled = true;

            try {
                // SSE ì—°ê²°
                if (currentEventSource) {
                    currentEventSource.close();
                }

                const eventSource = new EventSource(`/api/ai/chat?message=${encodeURIComponent(userMessage)}`);
                currentEventSource = eventSource;

                let fullResponse = '';
                let agentStatuses = {};

                eventSource.addEventListener('agent', (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        const { agent, status, message } = data;
                        
                        if (status === 'running') {
                            agentStatuses[agent] = 'running';
                            updateTypingMessage(aiMessageDiv, message || 'ì²˜ë¦¬ ì¤‘...');
                        } else if (status === 'complete') {
                            agentStatuses[agent] = 'completed';
                            updateTypingMessage(aiMessageDiv, 'ì²˜ë¦¬ ì¤‘...');
                        } else if (status === 'error' || status === 'failed') {
                            agentStatuses[agent] = 'failed';
                        } else if (status === 'warning') {
                            agentStatuses[agent] = 'warning';
                        }
                        
                        updateAgentBadges(aiMessageDiv, agentStatuses);
                    } catch (err) {
                        // Agent event parse error
                    }
                });

                eventSource.addEventListener('message', (e) => {
                    try {
                        fullResponse = e.data;

                        
                        // JSON ë°°ì—´ ì‘ë‹µì¸ ê²½ìš° (AttractionAgent ë“±ì˜ êµ¬ì¡°í™”ëœ ì¶œë ¥)
                        try {
                            const jsonData = JSON.parse(e.data);
                            
                            // ë°°ì—´ì¸ ê²½ìš° (ê´€ê´‘ì§€, ë§›ì§‘ ë“±)
                            if (Array.isArray(jsonData)) {
                                // JSONì„ ë³´ê¸° ì¢‹ê²Œ í¬ë§·íŒ…
                                fullResponse = JSON.stringify(jsonData, null, 2);
                            } 
                            // ê°ì²´ì´ê³  planì´ë‚˜ budgetAnalysisê°€ ìˆëŠ” ê²½ìš° (ì „ì²´ ì—¬í–‰ ê³„íš)
                            else if (jsonData.plan || jsonData.budgetAnalysis) {
                                // ì „ì²´ ì—¬í–‰ ê³„íšë„ ì±„íŒ…ì°½ì— í‘œì‹œ
                                fullResponse = formatTravelPlan(jsonData);
                            }
                        } catch {
                            // JSONì´ ì•„ë‹ˆë©´ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬
                        }
                    } catch (err) {
                        // Message event parse error
                    }
                });

                eventSource.addEventListener('complete', (e) => {
                    eventSource.close();
                    currentEventSource = null;
                    
                    // complete ì´ë²¤íŠ¸ì— ìµœì¢… ê²°ê³¼ê°€ í¬í•¨ë  ìˆ˜ ìˆìŒ
                    if (e.data && e.data.trim() !== '') {
                        fullResponse = e.data;
                    }
                    
                    // ìµœì¢… ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                    updateFinalMessage(aiMessageDiv, fullResponse || 'ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', agentStatuses);
                    
                    // ì…ë ¥ í™œì„±í™”
                    messageInput.disabled = false;
                    document.getElementById('sendButton').disabled = false;
                    messageInput.focus();
                });

                eventSource.onerror = (e) => {
                    eventSource.close();
                    currentEventSource = null;
                    updateFinalMessage(aiMessageDiv, fullResponse || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', agentStatuses);
                    
                    messageInput.disabled = false;
                    document.getElementById('sendButton').disabled = false;
                };

            } catch (error) {
                updateFinalMessage(aiMessageDiv, 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, {});
                messageInput.disabled = false;
                document.getElementById('sendButton').disabled = false;
            }
        }

        function addUserMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'd-flex align-items-start mb-3 justify-content-end';
            messageDiv.innerHTML = `
                <div class="bg-primary bg-gradient text-white rounded-3 p-3 shadow" style="max-width: 70%; order: 2;">
                    ${escapeHtml(message)}
                </div>
                <div class="bg-primary bg-gradient text-white rounded-circle d-flex align-items-center justify-content-center me-2 shadow" style="width: 45px; height: 45px; flex-shrink: 0; order: 1;">
                    <i class="fas fa-user-circle"></i>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addTypingIndicator(messageId) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = 'd-flex align-items-start mb-3';
            messageDiv.innerHTML = `
                <div class="text-white rounded-circle d-flex align-items-center justify-content-center me-3 shadow" style="width: 45px; height: 45px; flex-shrink: 0; font-weight: bold; font-size: 1rem; background-color: #6db33f;">
                    AI
                </div>
                <div style="max-width: 70%;">
                    <div class="agent-badges mb-2"></div>
                    <div class="bg-white rounded-3 p-3 shadow-sm message-content">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span class="text-muted">ì²˜ë¦¬ ì¤‘...</span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        function updateTypingMessage(messageDiv, content) {
            const contentDiv = messageDiv.querySelector('.message-content');
            contentDiv.innerHTML = `
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                <span class="text-muted">${escapeHtml(content)}</span>
            `;
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function updateAgentBadges(messageDiv, statuses) {
            const badgesContainer = messageDiv.querySelector('.agent-badges');
            if (!badgesContainer) {
                return;
            }
            
            // ê¸°ì¡´ ë°°ì§€ë“¤ì„ ìœ ì§€í•˜ë©´ì„œ ì—…ë°ì´íŠ¸
            const agentIcons = {
                'AttractionAgent': 'fa-landmark',
                'RestaurantAgent': 'fa-utensils',
                'AccommodationAgent': 'fa-hotel',
                'PlanAgent': 'fa-calendar-alt',
                'WeatherAgent': 'fa-cloud-sun',
                'BudgetAgent': 'fa-calculator',
                'YoutubeSearchAgent': 'fa-youtube'
            };
            
            // ê¸°ì¡´ ë°°ì§€ë“¤ì˜ ìƒíƒœ ë³´ì¡´ (ì™„ë£Œëœ ë°°ì§€ëŠ” ìœ ì§€)
            const existingBadges = {};
            Array.from(badgesContainer.children).forEach(badge => {
                const agent = badge.getAttribute('data-agent');
                if (agent) {
                    existingBadges[agent] = badge;
                }
            });
            
            // ëª¨ë“  ì—ì´ì „íŠ¸ì˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ + ìƒˆë¡œìš´)
            const allAgents = new Set([...Object.keys(existingBadges), ...Object.keys(statuses)]);
            
            allAgents.forEach(agent => {
                const status = statuses[agent] || 'completed'; // ìƒíƒœê°€ ì—†ìœ¼ë©´ ì™„ë£Œëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
                
                // ê¸°ì¡´ ë°°ì§€ ì°¾ê¸°
                let badge = existingBadges[agent];
                
                // ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                if (!badge) {
                    badge = document.createElement('span');
                    badge.setAttribute('data-agent', agent);
                    badge.className = 'badge me-1 mb-1 agent-badge';
                    badgesContainer.appendChild(badge);
                }
                
                // ìƒíƒœì— ë”°ë¼ ë°°ì§€ ìŠ¤íƒ€ì¼ ë° ë‚´ìš© ì—…ë°ì´íŠ¸
                const icon = agentIcons[agent] || 'fa-cog';
                let badgeClass = 'badge me-1 mb-1 agent-badge';
                let statusIcon = '';
                
                if (status === 'running') {
                    badgeClass += ' bg-warning text-dark';
                    statusIcon = '<i class="fas fa-spinner fa-spin me-1"></i>';
                } else if (status === 'completed') {
                    badgeClass += ' bg-success';
                    statusIcon = '<i class="fas fa-check me-1"></i>';
                } else if (status === 'failed') {
                    badgeClass += ' bg-danger';
                    statusIcon = '<i class="fas fa-times me-1"></i>';
                } else if (status === 'warning') {
                    badgeClass += ' bg-warning text-dark';
                    statusIcon = '<i class="fas fa-exclamation-triangle me-1"></i>';
                } else {
                    badgeClass += ' bg-secondary';
                    statusIcon = '<i class="fas fa-circle me-1"></i>';
                }
                
                badge.className = badgeClass;
                badge.innerHTML = `${statusIcon}<i class="fas ${icon} me-1"></i>${agent}`;
            });
        }

        function updateFinalMessage(messageDiv, content, statuses) {
            const contentDiv = messageDiv.querySelector('.message-content');
            
            // JSON íŒŒì‹± ì‹œë„
            try {
                const jsonData = JSON.parse(content);
                
                // TravelPlan í˜•ì‹ì¸ì§€ í™•ì¸ (daysì™€ totalCost í•„ë“œ ì¡´ì¬)
                if (jsonData.days && (jsonData.totalCost !== undefined || jsonData.budget)) {
                    contentDiv.innerHTML = renderTravelPlan(jsonData);
                }
                // JSON ë°°ì—´ì¸ ê²½ìš° (ê²€ìƒ‰ ê²°ê³¼)
                else if (Array.isArray(jsonData)) {
                    let htmlContent = '<div class="json-result">';
                    jsonData.forEach((item, index) => {
                        htmlContent += `<div class="mb-3 p-3 border rounded bg-white">`;
                        
                        // ì œëª©: name í•„ë“œ ì‚¬ìš©
                        const itemName = item.name || item.attractionName || 'í•­ëª©';
                        htmlContent += `<h6 class="text-primary mb-2"><strong>${index + 1}. ${itemName}</strong></h6>`;
                        
                        // ë‚˜ë¨¸ì§€ í•„ë“œë“¤ í‘œì‹œ
                        for (const [key, value] of Object.entries(item)) {
                            if (key !== 'name' && key !== 'attractionName') {
                                const labelMap = {
                                    'address': 'ğŸ“ ì£¼ì†Œ',
                                    'description': 'ğŸ“ ì„¤ëª…',
                                    'entranceFee': 'ğŸ’° ì…ì¥ë£Œ',
                                    'nightlyRate': 'ğŸ’° 1ë°• ìš”ê¸ˆ',
                                    'price': 'ğŸ’° ê°€ê²©ëŒ€'
                                };
                                const label = labelMap[key] || key;
                                htmlContent += `<p class="mb-1"><strong>${label}:</strong> ${value}</p>`;
                            }
                        }
                        htmlContent += `</div>`;
                    });
                    htmlContent += '</div>';
                    contentDiv.innerHTML = htmlContent;
                } else {
                    // ê¸°íƒ€ JSON ê°ì²´ëŠ” JSON viewerë¡œ í‘œì‹œ
                    contentDiv.innerHTML = renderJsonViewer(jsonData, 'JSON Response');
                }
            } catch {
                // JSONì´ ì•„ë‹ˆë©´ ë§ˆí¬ë‹¤ìš´ ê·¸ëŒ€ë¡œ í‘œì‹œ
                let cleanContent = content.trim();
                if ((cleanContent.startsWith('"') && cleanContent.endsWith('"')) || 
                    (cleanContent.startsWith("'") && cleanContent.endsWith("'"))) {
                    cleanContent = cleanContent.slice(1, -1);
                }
                contentDiv.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background: #f8f9fa; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; line-height: 1.6;">${escapeHtml(cleanContent)}</pre>`;
            }
            
            // ì—ì´ì „íŠ¸ ë°°ì§€ ìµœì¢… ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
            updateAgentBadges(messageDiv, statuses);
            
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function renderTravelPlan(planData) {
            let html = '<div class="travel-plan-container">';
            
            // ì¼ì • ë Œë”ë§
            if (planData.days && planData.days.length > 0) {
                html += '<div class="mb-4">';
                planData.days.forEach(day => {
                    html += `
                        <div class="bg-white rounded-3 p-4 mb-3 shadow-sm border-start border-primary border-4">
                            <h5 class="text-primary fw-bold mb-3">
                                <i class="fas fa-calendar-day me-2"></i>${day.day}ì¼ì°¨
                            </h5>
                    `;
                    
                    // ì‹œê°„ìˆœ ì¼ì •
                    if (day.schedule && day.schedule.length > 0) {
                        day.schedule.forEach(item => {
                            html += renderScheduleItem(item);
                        });
                    }
                    
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // ì˜ˆì‚° ë Œë”ë§
            html += renderBudget(planData);
            
            html += '</div>';
            return html;
        }

        function renderScheduleItem(item) {
            return `
                <div class="border-start border-2 border-light ps-3 mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <div class="mb-1">
                                <span class="badge bg-primary bg-gradient rounded-pill me-2">${item.time}</span>
                                <strong class="fs-6">${item.name}</strong>
                            </div>
                            <p class="text-muted small mb-1">
                                <i class="fas fa-map-marker-alt me-1"></i>${item.address}
                            </p>
                            <p class="mb-0 small">${item.description}</p>
                        </div>
                        <div class="ms-3">
                            <span class="badge bg-warning text-dark">${formatNumber(item.cost)}ì›</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBudget(planData) {
            // Plan ê°ì²´ì—ì„œ í•„ìš”í•œ í•„ë“œë“¤ ì¶”ì¶œ
            const meals = planData.meals || 0;
            const accommodation = planData.accommodation || 0;
            const attractions = planData.attractions || 0;
            const totalCost = planData.totalCost || (meals + accommodation + attractions);
            
            // maxBudgetì€ Plan ê°ì²´ì—ì„œ ê°€ì ¸ì˜´
            const maxBudget = planData.maxBudget || totalCost;
            const remaining = maxBudget - totalCost;
            
            return `
                <div class="bg-white rounded-3 p-4 shadow-sm">
                    <h5 class="text-primary fw-bold mb-3">
                        <i class="fas fa-wallet me-2"></i>ì˜ˆì‚° ë¶„ì„
                    </h5>
                    
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-utensils me-2 text-success"></i>ì‹ë¹„</span>
                            <strong>${formatNumber(meals)}ì›</strong>
                        </div>
                    </div>
                    
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-hotel me-2 text-info"></i>ìˆ™ë°•ë¹„</span>
                            <strong>${formatNumber(accommodation)}ì›</strong>
                        </div>
                    </div>
                    
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-ticket-alt me-2 text-warning"></i>ê´€ê´‘/ì…ì¥ë£Œ</span>
                            <strong>${formatNumber(attractions)}ì›</strong>
                        </div>
                    </div>
                    
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-bold">ì´ ì˜ˆìƒ ê²½ë¹„</span>
                            <strong class="text-primary fs-5">${formatNumber(totalCost)}ì›</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3 text-muted small">
                            <span>ìµœëŒ€ ì˜ˆì‚°</span>
                            <span>${formatNumber(maxBudget)}ì›</span>
                        </div>
                        
                        <div class="d-flex justify-content-between text-success">
                            <span class="small">ì”ì•¡</span>
                            <strong>${formatNumber(remaining)}ì›</strong>
                        </div>
                    </div>
                </div>
            `;
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function enhanceTravelPlanStyle(html) {
            // ì¤„ë°”ê¿ˆ ë¬¸ìë¥¼ <br> íƒœê·¸ë¡œ ë³€í™˜
            html = html.replace(/\\n/g, '<br>');
            
            // h3 íƒœê·¸ì— ìŠ¤íƒ€ì¼ ì¶”ê°€ (1ì¼ì°¨, 2ì¼ì°¨ ë“±)
            html = html.replace(/<h3>/g, '<h3 class="mt-4 mb-3 pb-2 border-bottom border-primary text-primary" style="font-weight: 600;">');
            
            // ### ì œëª© íŒ¨í„´ì„ h3ìœ¼ë¡œ ë³€í™˜ (Markdownì´ ì²˜ë¦¬ ëª»í•œ ê²½ìš°)
            html = html.replace(/###\s*(\d+ì¼ì°¨)/g, '<h3 class="mt-4 mb-3 pb-2 border-bottom border-primary text-primary" style="font-weight: 600;">$1</h3>');
            
            // êµ¬ë¶„ì„ (---) íŒ¨í„´ ë³€í™˜
            html = html.replace(/---/g, '<hr class="my-4" style="border-top: 2px solid #667eea;">');
            html = html.replace(/<hr>/g, '<hr class="my-4" style="border-top: 2px solid #667eea;">');
            
            // - ë¡œ ì‹œì‘í•˜ëŠ” ë¦¬ìŠ¤íŠ¸ í•­ëª©ì„ bullet pointë¡œ ë³€í™˜
            html = html.replace(/-\s+ì˜¤ì „:/g, '<div class="mb-2 ms-3" style="line-height: 1.8;">ğŸŒ… <strong>ì˜¤ì „:</strong>');
            html = html.replace(/-\s+ì˜¤í›„:/g, '<div class="mb-2 ms-3" style="line-height: 1.8;">â˜€ï¸ <strong>ì˜¤í›„:</strong>');
            html = html.replace(/-\s+ì €ë…:/g, '<div class="mb-2 ms-3" style="line-height: 1.8;">ğŸŒ™ <strong>ì €ë…:</strong>');
            html = html.replace(/-\s+/g, '<div class="mb-2 ms-3" style="line-height: 1.8;">â€¢ ');
            
            // ì¤‘ì²©ëœ ë¦¬ìŠ¤íŠ¸ í•­ëª© (ì£¼ì†Œ, ì„¤ëª…, ì…ì¥ë£Œ)
            html = html.replace(/\s+-\s+ì£¼ì†Œ:/g, '<div class="ms-4 mb-1" style="color: #666; font-size: 0.95rem;"><strong>ğŸ“ ì£¼ì†Œ:</strong>');
            html = html.replace(/\s+-\s+ì„¤ëª…:/g, '<div class="ms-4 mb-1" style="color: #666; font-size: 0.95rem;"><strong>ğŸ“ ì„¤ëª…:</strong>');
            html = html.replace(/\s+-\s+ì…ì¥ë£Œ:/g, '<div class="ms-4 mb-1" style="color: #666; font-size: 0.95rem;"><strong>ğŸ’° ì…ì¥ë£Œ:</strong>');
            
            // div íƒœê·¸ ë‹«ê¸° (ê° í•­ëª© ëì—)
            html = html.replace(/<div class="mb-2 ms-3"[^>]*>([^<]*(?:<[^/][^>]*>[^<]*<\/[^>]*>)*[^<]*)<br>/g, '<div class="mb-2 ms-3" style="line-height: 1.8;">$1</div>');
            html = html.replace(/<div class="ms-4 mb-1"[^>]*>([^<]*(?:<[^/][^>]*>[^<]*<\/[^>]*>)*[^<]*)<br>/g, '<div class="ms-4 mb-1" style="color: #666; font-size: 0.95rem;">$1</div>');
            
            // ul/li ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê°œì„  (Markdown ì²˜ë¦¬ëœ ê²½ìš°)
            html = html.replace(/<ul>/g, '<ul class="list-unstyled ms-3">');
            html = html.replace(/<li>/g, '<li class="mb-2" style="line-height: 1.8;">â€¢ ');
            
            // ì¤‘ì²©ëœ ul (ê´€ê´‘ì§€ ìƒì„¸ ì •ë³´) ìŠ¤íƒ€ì¼
            html = html.replace(/<ul class="list-unstyled ms-3">\s*<li class="mb-2" style="line-height: 1\.8;">â€¢\s*<ul>/g, 
                '<ul class="ms-4 mt-2 mb-2"><li style="list-style: none;"><ul>');
            
            // ë‚´ë¶€ ë¦¬ìŠ¤íŠ¸ í•­ëª© ìŠ¤íƒ€ì¼ (ì£¼ì†Œ, ì„¤ëª…, ì…ì¥ë£Œ)
            html = html.replace(/(<ul>(?:(?!<\/ul>).)*?)<li class="mb-2" style="line-height: 1\.8;">â€¢\s*ì£¼ì†Œ:/g, 
                '$1<li class="mb-1" style="color: #666;"><strong>ğŸ“ ì£¼ì†Œ:</strong>');
            html = html.replace(/(<ul>(?:(?!<\/ul>).)*?)<li class="mb-2" style="line-height: 1\.8;">â€¢\s*ì„¤ëª…:/g, 
                '$1<li class="mb-1" style="color: #666;"><strong>ğŸ“ ì„¤ëª…:</strong>');
            html = html.replace(/(<ul>(?:(?!<\/ul>).)*?)<li class="mb-2" style="line-height: 1\.8;">â€¢\s*ì…ì¥ë£Œ:/g, 
                '$1<li class="mb-1" style="color: #666;"><strong>ğŸ’° ì…ì¥ë£Œ:</strong>');
            
            // ì—°ì†ëœ <br> íƒœê·¸ë¥¼ í•˜ë‚˜ë¡œ ì¤„ì„
            html = html.replace(/(<br>\s*){3,}/g, '<br><br>');
            
            return html;
        }

        function formatTravelPlan(planData) {
            let result = '## ì—¬í–‰ ê³„íš\n\n';
            
            if (planData.attractionInfo) {
                result += '### ğŸ›ï¸ ê´€ê´‘ì§€ ì •ë³´\n' + planData.attractionInfo + '\n\n';
            }
            
            if (planData.restaurantInfo) {
                result += '### ğŸ½ï¸ ë§›ì§‘ ì •ë³´\n' + planData.restaurantInfo + '\n\n';
            }
            
            if (planData.accommodationInfo) {
                result += '### ğŸ¨ ìˆ™ì†Œ ì •ë³´\n' + planData.accommodationInfo + '\n\n';
            }
            
            if (planData.plan) {
                result += '### ğŸ“… ì—¬í–‰ ì¼ì •\n' + planData.plan + '\n\n';
            }
            
            if (planData.budgetAnalysis) {
                result += '### ğŸ’° ì˜ˆì‚° ë¶„ì„\n' + planData.budgetAnalysis + '\n\n';
            }
            
            return result;
        }

        function renderJsonViewer(jsonData, title = 'JSON') {
            const jsonString = JSON.stringify(jsonData, null, 2);
            const jsonId = 'json-' + Date.now();
            
            return `
                <div class="json-viewer-container">
                    <div class="json-viewer-header">
                        <span class="json-viewer-title"><i class="fas fa-code me-2"></i>${title}</span>
                        <div class="json-viewer-controls">
                            <button class="json-btn" onclick="toggleJsonCollapse('${jsonId}')">
                                <i class="fas fa-compress-alt"></i>ì ‘ê¸°/í¼ì¹˜ê¸°
                            </button>
                            <button class="json-btn" onclick="copyJson('${jsonId}')">
                                <i class="fas fa-copy"></i>ë³µì‚¬
                            </button>
                            <button class="json-btn" onclick="downloadJson('${jsonId}', '${title}')">
                                <i class="fas fa-download"></i>ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                    </div>
                    <div class="json-content" id="${jsonId}">${syntaxHighlight(jsonString)}</div>
                </div>
            `;
        }
        
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^"\\])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        
        function copyJson(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                // ë³µì‚¬ ì™„ë£Œ ì•Œë¦¼
                const btn = event.target.closest('.json-btn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-1"></i>ë³µì‚¬ë¨!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = '#333';
                }, 2000);
            });
        }
        
        function toggleJsonCollapse(elementId) {
            const element = document.getElementById(elementId);
            const content = element.textContent;
            
            if (element.dataset.collapsed === 'true') {
                // í¼ì¹˜ê¸°
                element.innerHTML = syntaxHighlight(element.dataset.fullContent);
                element.dataset.collapsed = 'false';
            } else {
                // ì ‘ê¸°
                element.dataset.fullContent = content;
                try {
                    const parsed = JSON.parse(content);
                    const collapsed = JSON.stringify(parsed);
                    element.innerHTML = syntaxHighlight(collapsed);
                    element.dataset.collapsed = 'true';
                } catch (e) {
                    // JSON parse error
                }
            }
        }
        
        function downloadJson(elementId, filename) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            const blob = new Blob([text], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì…ë ¥ì°½ í¬ì»¤ìŠ¤
        window.onload = () => {
            document.getElementById('messageInput').focus();
        };
    </script>
</body>
</html>
